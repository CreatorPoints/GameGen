<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal The Last Dance - Photon Studios</title>
    <style>
        /* --- Reusable Cosmic Theme Styles --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            color: white;
            background: #1b2838;
            overflow-x: hidden;
            position: relative; /* For overlay positioning */
        }
        #bg-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: -2;
        }
        .dark-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.85);
            z-index: -1;
        }
        .navbar {
            position: fixed;
            top: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 40px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 100;
        }
        .logo { font-size: 1.8rem; font-weight: bold; color: #fff; }
        .nav-links { display: flex; gap: 30px; }
        .nav-links a { color: #ccc; text-decoration: none; transition: 0.3s; }
        .nav-links a:hover { color: #fff; }
        #login-btn {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid white;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            backdrop-filter: blur(6px);
            font-weight: bold;
        }
        #login-btn:hover { background: rgba(255, 255, 255, 0.25); }
        .container { padding: 100px 40px 40px; }
        /* --- End Reusable Styles --- */

        /* --- Specific Game Page Styles --- */
        .game-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .game-title { font-size: 2.5rem; margin-bottom: 10px; }
        .game-tagline { font-size: 1.2rem; color: #aaa; margin-bottom: 20px; }
        .game-image-main {
            width: 100%;
            max-width: 800px;
            margin: 0 auto 20px;
            display: block;
            border-radius: 8px;
            object-fit: cover;
            height: 400px; /* Adjust height as needed */
        }
        .game-meta {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .meta-item { background: rgba(50, 60, 70, 0.6); padding: 8px 15px; border-radius: 4px; }
        .game-description { max-width: 800px; margin: 0 auto 30px; line-height: 1.6; }
        .game-actions { text-align: center; margin-bottom: 30px; }
        .btn-buy, .btn-download {
            padding: 12px 25px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 10px;
            font-size: 1rem;
            transition: 0.2s;
        }
        .btn-buy { background: #5aa9e6; color: white; }
        .btn-buy:hover { background: #4a99d6; }
        .btn-download { background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid #555; }
        .btn-download:hover { background: rgba(255, 255, 255, 0.2); }
        .like-dislike-section {
            text-align: center;
            margin: 20px 0 40px;
        }
        .like-dislike-buttons {
            display: inline-flex;
            gap: 15px;
            align-items: center;
        }
        .like-btn, .dislike-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1.8rem;
            transition: 0.2s;
            padding: 5px;
        }
        .like-btn:hover, .dislike-btn:hover { color: #5aa9e6; }
        .like-btn.active { color: #4caf50; }
        .dislike-btn.active { color: #f44336; }
        .rating-count { font-size: 1rem; color: #aaa; margin: 0 10px; }
        .comments-section { max-width: 800px; margin: 0 auto; }
        .comments-header { margin-bottom: 20px; }
        .comments-header h2 { display: inline-block; margin-right: 15px; }
        .comments-sort { display: inline-block; }
        .comment-form { margin-bottom: 30px; }
        .comment-form textarea {
            width: 100%;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #555;
            background: rgba(30, 40, 50, 0.8);
            color: white;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 10px;
        }
        .comment-form button {
            padding: 10px 20px;
            background: #5aa9e6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .comment-form button:hover { background: #4a99d6; }
        .comment-list { }
        .comment-item {
            padding: 15px;
            background: rgba(30, 40, 50, 0.6);
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .comment-author { font-weight: bold; color: #5aa9e6; }
        .comment-date { font-size: 0.8rem; color: #777; }
        .comment-content { line-height: 1.5; }
        .comment-actions { margin-top: 8px; }
        .comment-like-btn, .comment-dislike-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 0.9rem;
            margin-right: 10px;
        }
        .comment-like-btn:hover, .comment-dislike-btn:hover { color: #5aa9e6; }
        .comment-like-btn.active { color: #4caf50; }
        .comment-dislike-btn.active { color: #f44336; }
        .comment-rating-count { font-size: 0.8rem; color: #aaa; margin-left: 5px; }
    </style>
</head>
<body>
    <video id="bg-video" autoplay muted loop>
        <source src="videos/blackhole.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>
    <div class="dark-overlay"></div>

    <div class="navbar">
        <div class="logo">PHOTON STUDIOS</div>
        <div style="display:flex;align-items:center;gap:30px;">
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="../photonstore.html">Shop</a>
                <a href="photonstudios.html">News</a>
            </div>
            <button id="login-btn">Login</button>
        </div>
    </div>

    <div class="container">
        <div class="game-header">
            <h1 class="game-title">Portal TLD</h1>
            <p class="game-tagline">The ultimate puzzle experience</p>
            <img src="https://placehold.co/800x400/222222/FFFFFF?text=Portal+TLD+Hero+Image" alt="Portal TLD Hero Image" class="game-image-main">
            <div class="game-meta">
                <div class="meta-item">Developer: Photon Studios</div>
                <div class="meta-item">Publisher: Photon Studios</div>
                <div class="meta-item">Release Date: Coming Soon</div>
                <div class="meta-item">Genre: Puzzle</div>
            </div>
        </div>

        <div class="game-description">
            <p>Step into the test chambers of Portal TLD, where physics-defying puzzles await. Master the portal gun, manipulate momentum, and solve intricate challenges in a world where the only way out is through the next portal. Experience a mind-bending adventure that combines clever mechanics with a gripping narrative.</p>
            <p>Features:</p>
            <ul>
                <li>Revolutionary Portal Physics</li>
                <li>Challenging Puzzle Chambers</li>
                <li>Intriguing Storyline</li>
                <li>Stunning Visuals</li>
            </ul>
        </div>

        <div class="game-actions">
            <button class="btn-buy" id="buy-btn">Buy Now - $24.99</button>
            <button class="btn-download" id="demo-btn">Download Demo</button>
        </div>

        <div class="like-dislike-section">
            <h3>How do you feel about Portal TLD?</h3>
            <div class="like-dislike-buttons">
                <button class="like-btn" id="like-btn">üëç</button>
                <span class="rating-count" id="like-count">0</span>
                <span> / </span>
                <span class="rating-count" id="dislike-count">0</span>
                <button class="dislike-btn" id="dislike-btn">üëé</button>
            </div>
        </div>

        <div class="comments-section">
            <div class="comments-header">
                <h2>Community Reviews</h2>
                <select class="comments-sort" id="comments-sort">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="popular">Most Popular</option>
                </select>
            </div>

            <div class="comment-form">
                <textarea id="comment-input" placeholder="Write your review or comment..."></textarea>
                <button id="post-comment-btn">Post Comment</button>
            </div>

            <div class="comment-list" id="comment-list">
                <!-- Comments will be loaded here -->
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase Setup ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        // Import Firestore for likes/comments
        import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, increment, query, collection, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        const firebaseConfig = {
            // TODO: Replace with YOUR Firebase config from the console
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- State Variables ---
        let currentUser = null;
        const gameId = 'portal-tld'; // Unique identifier for this game page

        // --- DOM Elements ---
        const loginBtn = document.getElementById('login-btn');
        const likeBtn = document.getElementById('like-btn');
        const dislikeBtn = document.getElementById('dislike-btn');
        const likeCountEl = document.getElementById('like-count');
        const dislikeCountEl = document.getElementById('dislike-count');
        const commentInput = document.getElementById('comment-input');
        const postCommentBtn = document.getElementById('post-comment-btn');
        const commentListEl = document.getElementById('comment-list');
        const commentsSortEl = document.getElementById('comments-sort');
        const buyBtn = document.getElementById('buy-btn');
        const demoBtn = document.getElementById('demo-btn');

        // --- Firebase Auth State ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                console.log("User is signed in:", user.uid);
                loginBtn.textContent = user.displayName || user.email || 'Logged In';
            } else {
                console.log("No user is signed in.");
                loginBtn.textContent = 'Login';
            }
        });

        // --- Login/Logout Functionality ---
        loginBtn.addEventListener('click', () => {
            if (currentUser) {
                signOut(auth).then(() => {
                    console.log("User signed out.");
                    // Button text will update via onAuthStateChanged
                }).catch((error) => {
                    console.error("Sign out error:", error);
                });
            } else {
                signInWithPopup(auth, provider)
                    .then((result) => {
                        currentUser = result.user;
                        console.log('User signed in successfully:', currentUser.uid);
                        // Button text will update via onAuthStateChanged
                    })
                    .catch((error) => {
                        console.error('Login error:', error);
                        alert('Login failed: ' + error.message);
                    });
            }
        });

        // --- Game Data Functions (Placeholder for Firestore structure) ---
        // You will need to set up these documents/collections in your Firestore console:
        // Collection: 'games'
        // Document ID: 'portal-tld' (or your gameId)
        // Fields: likes: number, dislikes: number
        // Collection: 'games' / Document: 'portal-tld' / Subcollection: 'comments'
        // Subcollection fields: userId: string, userName: string, text: string, timestamp: date, likes: number, dislikes: number

        async function loadGameRatings() {
            // TODO: Replace 'games' with your actual collection name if different
            const gameRef = doc(db, 'games', gameId);
            const gameSnap = await getDoc(gameRef);

            if (gameSnap.exists()) {
                const data = gameSnap.data();
                likeCountEl.textContent = data.likes || 0;
                dislikeCountEl.textContent = data.dislikes || 0;
            } else {
                console.log("Game document does not exist, initializing...");
                // Optionally initialize the document if it doesn't exist
                await setDoc(gameRef, { likes: 0, dislikes: 0 });
                likeCountEl.textContent = '0';
                dislikeCountEl.textContent = '0';
            }
        }

        async function loadComments() {
            // TODO: Replace 'games' and 'comments' with your actual collection names if different
            const commentsRef = collection(db, 'games', gameId, 'comments');
            let q = query(commentsRef, orderBy('timestamp', 'desc')); // Default to newest first

            // Apply sorting based on dropdown selection
            const sortValue = commentsSortEl.value;
            if (sortValue === 'oldest') {
                q = query(commentsRef, orderBy('timestamp', 'asc'));
            } else if (sortValue === 'popular') {
                // Firestore doesn't support complex sorting like 'popularity' out of the box easily.
                // You might need to add a 'popularity' field and update it, or fetch all and sort client-side.
                // For now, we'll keep it simple with timestamp sorting.
                q = query(commentsRef, orderBy('timestamp', 'desc')); // Keeping desc for now
            }

            const querySnapshot = await getDocs(q);
            commentListEl.innerHTML = ''; // Clear existing comments

            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const commentId = doc.id; // Firestore document ID for the comment

                const commentEl = document.createElement('div');
                commentEl.className = 'comment-item';
                commentEl.innerHTML = `
                    <div class="comment-header">
                        <div class="comment-author">${data.userName || 'Anonymous'}</div>
                        <div class="comment-date">${data.timestamp?.toDate().toLocaleString() || 'Unknown Date'}</div>
                    </div>
                    <div class="comment-content">${data.text}</div>
                    <div class="comment-actions">
                        <button class="comment-like-btn" data-comment-id="${commentId}" data-user-id="${currentUser?.uid || ''}">üëç <span class="comment-rating-count">${data.likes || 0}</span></button>
                        <button class="comment-dislike-btn" data-comment-id="${commentId}" data-user-id="${currentUser?.uid || ''}">üëé <span class="comment-rating-count">${data.dislikes || 0}</span></button>
                    </div>
                `;
                commentListEl.appendChild(commentEl);
            });

            // Add event listeners to the new like/dislike buttons for comments
            document.querySelectorAll('.comment-like-btn, .comment-dislike-btn').forEach(btn => {
                btn.addEventListener('click', handleCommentInteraction);
            });
        }


        // --- Interaction Handlers ---
        async function handleLikeDislike(buttonType) {
            if (!currentUser) {
                alert('Please log in to like or dislike.');
                return;
            }

            const gameRef = doc(db, 'games', gameId);
            const userInteractionRef = doc(db, 'games', gameId, 'userInteractions', currentUser.uid); // Subcollection for user interactions

            try {
                // Get current user's interaction state
                const userInteractionSnap = await getDoc(userInteractionRef);
                const currentInteraction = userInteractionSnap.exists() ? userInteractionSnap.data().action : null;

                // Determine the new action
                const newAction = (currentInteraction === buttonType) ? null : buttonType; // Toggle off if same button clicked again

                // Prepare updates for game ratings
                const gameUpdates = {};
                if (currentInteraction === 'like') gameUpdates.likes = increment(-1);
                if (currentInteraction === 'dislike') gameUpdates.dislikes = increment(-1);
                if (newAction === 'like') gameUpdates.likes = increment(1);
                if (newAction === 'dislike') gameUpdates.dislikes = increment(1);

                // Prepare updates for user interaction record
                const userInteractionData = newAction ? { action: newAction } : null;

                // Perform the updates
                await updateDoc(gameRef, gameUpdates);
                if (userInteractionData) {
                    await setDoc(userInteractionRef, userInteractionData);
                } else {
                    await updateDoc(userInteractionRef, { action: deleteField() }); // Remove the field if toggling off
                }

                // Update UI immediately (optimistic update)
                if (currentInteraction === 'like') {
                    likeCountEl.textContent = parseInt(likeCountEl.textContent) - 1;
                    likeBtn.classList.remove('active');
                }
                if (currentInteraction === 'dislike') {
                    dislikeCountEl.textContent = parseInt(dislikeCountEl.textContent) - 1;
                    dislikeBtn.classList.remove('active');
                }
                if (newAction === 'like') {
                    likeCountEl.textContent = parseInt(likeCountEl.textContent) + 1;
                    likeBtn.classList.add('active');
                    if (currentInteraction === 'dislike') {
                        dislikeCountEl.textContent = parseInt(dislikeCountEl.textContent) - 1;
                        dislikeBtn.classList.remove('active');
                    }
                }
                if (newAction === 'dislike') {
                    dislikeCountEl.textContent = parseInt(dislikeCountEl.textContent) + 1;
                    dislikeBtn.classList.add('active');
                    if (currentInteraction === 'like') {
                        likeCountEl.textContent = parseInt(likeCountEl.textContent) - 1;
                        likeBtn.classList.remove('active');
                    }
                }

                console.log(`User ${currentUser.uid} ${newAction ? 'set action to ' + newAction : 'removed action'} for game ${gameId}`);

            } catch (error) {
                console.error("Error updating like/dislike:", error);
                alert("An error occurred. Please try again.");
                // Reload ratings to revert optimistic update if needed
                loadGameRatings();
            }
        }

        async function handlePostComment() {
            if (!currentUser) {
                alert('Please log in to post a comment.');
                return;
            }

            const text = commentInput.value.trim();
            if (!text) {
                alert('Please enter a comment.');
                return;
            }

            try {
                // TODO: Replace 'games' and 'comments' with your actual collection names if different
                const commentsRef = collection(db, 'games', gameId, 'comments');
                await addDoc(commentsRef, {
                    userId: currentUser.uid,
                    userName: currentUser.displayName || currentUser.email || 'Anonymous User',
                    text: text,
                    timestamp: new Date(), // Firestore Timestamp
                    likes: 0,
                    dislikes: 0
                });

                commentInput.value = ''; // Clear input
                console.log(`Comment posted by ${currentUser.uid} for game ${gameId}`);
                loadComments(); // Reload comments to show the new one
            } catch (error) {
                console.error("Error posting comment:", error);
                alert("An error occurred posting your comment. Please try again.");
            }
        }

        async function handleCommentInteraction(event) {
            // This is a placeholder for future implementation.
            // Interacting with individual comment likes/dislikes requires a more complex Firestore structure
            // (e.g., tracking user votes on specific comments).
            // For now, we'll just log the attempt.
            console.log("Comment interaction attempted (not fully implemented yet).");
            alert("Comment voting is coming soon!");
            // TODO: Implement user-specific voting on comments in Firestore.
        }

        // --- Event Listeners ---
        likeBtn.addEventListener('click', () => handleLikeDislike('like'));
        dislikeBtn.addEventListener('click', () => handleLikeDislike('dislike'));
        postCommentBtn.addEventListener('click', handlePostComment);
        commentsSortEl.addEventListener('change', loadComments); // Reload comments when sort changes

        // TODO: Implement Buy/Download functionality
        buyBtn.addEventListener('click', () => {
             if (!currentUser) {
                alert('Please log in to purchase.');
                return;
            }
            // TODO: Integrate with a real payment system (e.g., Stripe, PayPal)
            alert(`Redirecting to payment for Portal TLD ($24.99)... (Integration Required)`);
            // Example: window.open('https://your-payment-gateway.com/checkout?game=portal-tld', '_blank');
        });
        demoBtn.addEventListener('click', () => {
            // TODO: Provide a link to the demo download
            alert('Redirecting to demo download... (Link Required)');
            // Example: window.open('https://your-download-server.com/demo/portal-tld.zip', '_blank');
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            await loadGameRatings();
            await loadComments();
        });

    </script>
</body>
</html>